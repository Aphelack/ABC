# Лабораторная работа 2: Переходы между режимами процессора

## Описание программы

Данная программа демонстрирует **переходы между реальным и защищённым режимами** процессора x86. Программа показывает полный цикл: Real Mode → Protected Mode → Real Mode, что является фундаментальной основой работы операционных систем.

## Ключевые концепции и команды

### 1. Настройка Global Descriptor Table (GDT)
```asm
gdt_start:
gdt_null:    dd 0x0, 0x0                      ; Нулевой дескриптор (обязательный)
gdt_code:    dw 0xffff, 0x0                   ; Сегмент кода (4GB, исполняемый)
             db 0x0, 10011010b, 11001111b, 0x0
gdt_data:    dw 0xffff, 0x0                   ; Сегмент данных (4GB, читаемый/записываемый)
             db 0x0, 10010010b, 11001111b, 0x0
gdt_real:    dw 0xffff, 0x0                   ; Специальный дескриптор для возврата
             db 0x0, 10011010b, 00000000b, 0x0
```

**Объяснение**: GDT определяет сегменты памяти с их правами доступа. Биты управляют привилегиями, типом сегмента и размером.

### 2. Переход в защищённый режим
```asm
cli                    ; Отключаем прерывания (критически важно!)
lgdt [gdt_descriptor] ; Загружаем адрес таблицы GDT
mov eax, cr0
or eax, 1             ; Устанавливаем бит PE (Protection Enable)
mov cr0, eax          ; Активируем защищённый режим
jmp CODE_SEG:pm       ; Far jump для очистки префетч-очереди
```

**Принцип**: Бит PE в регистре CR0 переключает процессор между режимами. Far jump обязателен для корректной работы.

### 3. Работа с расширенной памятью (>1MB)
```asm
mov edi, 0x200000     ; Адрес 2MB (недоступен в реальном режиме)
mov eax, 0xCAFEBABE   ; Тестовое значение
mov [edi], eax        ; Записываем в память
cmp eax, [edi]        ; Проверяем корректность записи
je .ok                ; Переход если тест успешен
```

**Особенность**: В реальном режиме доступно только 1MB памяти. Защищённый режим снимает это ограничение.

### 4. Вывод на VGA-дисплей
```asm
mov edi, 0xB8000      ; Базовый адрес текстового видеорежима
mov ax, 0x4F50        ; 'P' - белый символ на красном фоне
mov [edi], ax         ; Записываем символ с атрибутом цвета
mov ax, 0x4F4D        ; 'M' - белый символ на красном фоне
mov [edi+2], ax       ; Следующая позиция на экране
```

**Формат**: Каждый символ занимает 2 байта: ASCII-код + атрибут цвета (фон|текст).

### 5. Возврат в реальный режим
```asm
mov eax, cr0
and eax, 0xFFFFFFFE   ; Сбрасываем бит PE (Protection Enable)
mov cr0, eax          ; Выключаем защищённый режим
jmp 0:real            ; Far jump с сегментом 0
```

**Важно**: Far jump с нулевым сегментом восстанавливает сегментные регистры для реального режима.

### 6. Восстановление реального режима
```asm
xor ax, ax            ; Обнуляем AX
mov ds, ax            ; Восстанавливаем сегментные регистры
mov es, ax            ; для реального режима (все = 0)
mov ss, ax
sti                   ; Включаем прерывания обратно
```

## Результат выполнения программы

```
Lab 2: Real->Protected->Real Demo
Protected Mode Active!
Memory test OK
Back in Real Mode!
```

**Анализ вывода**:
1. **"Real->Protected->Real Demo"** - программа запускается в реальном режиме
2. **"Protected Mode Active!"** - успешный переход в защищённый режим  
3. **"Memory test OK"** - тест доступа к памяти по адресу 2MB прошёл успешно
4. **"Back in Real Mode!"** - программа вернулась в реальный режим

## Образовательная ценность

Программа демонстрирует:

1. **Архитектуру x86** - понимание сегментации и управления памятью
2. **Bootloader development** - основы загрузки операционных систем
3. **Низкоуровневое программирование** - прямая работа с регистрами процессора
4. **Управление памятью** - доступ к расширенной памяти
5. **Системное программирование** - переключение между режимами CPU

## Практическое применение

### В операционных системах:
- **Linux kernel** - переходит в защищённый режим при загрузке
- **Windows bootloader** - использует аналогичные техники
- **GRUB** - демонстрирует переходы между режимами

### В embedded системах:
- **Микроконтроллеры** - управление режимами энергопотребления
- **Real-time системы** - переключение контекстов

## Ключевые особенности реализации

- **Размер**: Точно 512 байт (стандарт Master Boot Record)
- **Совместимость**: Работает на любом x86 процессоре
- **Безопасность**: Корректное управление прерываниями
- **Тестирование**: Проверка доступности расширенной памяти
- **Визуализация**: Цветной вывод показывает активный режим

## Технические детали

**Цветовая схема экрана**:
- **PM** (красный фон) - индикатор защищённого режима
- **Serial output** (цветные ANSI-коды) - детальная информация

**Memory mapping**:
- `0x7c00` - адрес загрузки bootloader
- `0xB8000` - видеопамять VGA text mode  
- `0x200000` - тестовый адрес в расширенной памяти (2MB)

Это практическая демонстрация фундаментальных принципов работы современных процессоров и операционных систем!